{% extends "base.html" %}

<!-- dev-signature: 29a41de6a866d56c36aba5159f45257c -->
{% block content %}
<!-- Special styling to fix modal issues -->
<style>
    /* Fix for modals and interactive elements */
    .modal, .modal-dialog, .modal-content {
        pointer-events: all !important;
    }
    
    .modal-backdrop {
        z-index: 1050 !important;
    }
    
    .modal {
        z-index: 1055 !important;
    }
    
    .modal-dialog {
        z-index: 1060 !important;
    }
    
    .modal-content {
        z-index: 1065 !important;
    }
    
    /* Make sure form controls are above other elements */
    .modal input,
    .modal select,
    .modal textarea,
    .modal button {
        position: relative;
        z-index: 1070 !important;
    }
    
    .modal .form-control:focus,
    .modal .form-select:focus,
    .modal button:focus {
        box-shadow: 0 0 0 0.25rem rgba(255, 215, 0, 0.25) !important;
        outline: none !important;
    }
    
    /* Fix dropdown menu in modal */
    .modal .dropdown-menu {
        z-index: 1075 !important;
    }
    
    /* Improve accessibility */
    .dropdown-item:focus {
        outline: 2px solid #fbbf24 !important;
    }
    
    /* Cursor helpers */
    .cursor-pointer {
        cursor: pointer;
    }
    
    .cursor-pointer:hover {
        text-decoration: underline;
    }
</style>

<div class="container">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>Manage Categories</h2>
                <div>
                    {% set has_defaults = False %}
                    {% set default_categories = ["Housing", "Food", "Transportation", "Shopping", "Entertainment", "Health"] %}
                    
                    {% set default_count = 0 %}
                    {% for cat in categories %}
                      {% if cat.name in default_categories %}
                        {% set default_count = default_count + 1 %}
                      {% endif %}
                    {% endfor %}
                    
                    {% if default_count < 4 %}
                    <form action="{{ url_for('user_create_default_categories') }}" method="POST" class="d-inline me-2">
                      <button type="submit" class="btn btn-outline-success">
                        <i class="fas fa-tags me-1"></i> Add Default Categories
                      </button>
                    </form>
                    {% endif %}
                    
                    <button id="toggleCategoryForm" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Add Category
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Category Form (Hidden by default) -->
    <div id="categoryFormContainer" class="expense-form mb-4" style="display: none;">
        <h4 class="mb-3">Create New Category</h4>
        <form action="{{ url_for('add_category') }}" method="POST">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="name" class="form-label">Category Name</label>
                    <input type="text" class="form-control bg-dark text-light" id="name" name="name" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="parent_id" class="form-label">Parent Category (Optional)</label>
                    <select class="form-select bg-dark text-light" id="parent_id" name="parent_id">
                        <option value="">None (Top-level category)</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="icon" class="form-label">Icon</label>
                    <div class="input-group">
                        <span class="input-group-text bg-dark text-light" id="selected-icon-preview">
                            <i class="fas fa-tag"></i>
                        </span>
                        <select class="form-select bg-dark text-light" id="icon" name="icon">
                            {% for icon in icons %}
                                <option value="{{ icon }}" {% if icon == 'fa-tag' %}selected{% endif %}>
                                    {{ icon }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="color" class="form-label">Color</label>
                    <div class="input-group">
                        <input type="color" class="form-control form-control-color bg-dark" id="color" name="color" value="#6c757d">
                        <input type="text" class="form-control bg-dark text-light" id="colorHex" value="#6c757d" readonly>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-secondary me-2" onclick="toggleCategoryForm()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Category</button>
            </div>
        </form>
    </div>

    <!-- Category Management Card -->
    <div class="card mt-4 mb-4">
        <div class="card-header">
            <h5 class="mb-0">Category Management</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">Manage your default categories and reset options.</p>
            
            <div class="d-flex flex-wrap gap-3">
                <form action="{{ url_for('restore_default_categories') }}" method="POST">
                    <button type="submit" class="btn btn-outline-light" 
                          onclick="return confirm('Restore default categories? This will not affect your existing categories or restore ones you explicitly deleted.')">
                        <i class="fas fa-undo me-2"></i>Restore Default Categories
                    </button>
                </form>
                
                <form action="{{ url_for('clear_category_deletion_history') }}" method="POST">
                    <button type="submit" class="btn btn-outline-warning" 
                          onclick="return confirm('Are you sure? This will allow previously deleted default categories to be restored next time you use the restore function.')">
                        <i class="fas fa-eraser me-2"></i>Clear Deletion History
                    </button>
                </form>
            </div>
            
            <p class="text-muted small mt-2">
                <strong>Restore Default Categories:</strong> Adds back any missing default categories that you haven't explicitly deleted.<br>
                <strong>Clear Deletion History:</strong> Forgets which categories you've deleted, allowing them to be restored again.
            </p>
        </div>
    </div>

    <!-- Categories Display -->
    <div class="row">
        {% for category in categories %}
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center" style="background-color: {{ category.color }}20;">
                    <h5 class="card-title mb-0 d-flex align-items-center">
                        <i class="fas {{ category.icon }} me-2" style="color: {{ category.color }};"></i>
                        <span>{{ category.name }}</span>
                    </h5>
                    {% if not category.is_system %}
                    <div class="dropdown">
                        <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="categoryActions{{ category.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end bg-dark" aria-labelledby="categoryActions{{ category.id }}">
                            <li><a class="dropdown-item text-light" href="#" onclick="openEditCategory({{ category.id }}, '{{ category.name }}', '{{ category.icon }}', '{{ category.color }}'); return false;">
                                <i class="fas fa-edit me-2"></i>Edit
                            </a></li>
                            <li><hr class="dropdown-divider border-secondary"></li>
                            <li>
                                <form action="{{ url_for('delete_category', category_id=category.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this category?');">
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i class="fas fa-trash-alt me-2"></i>Delete
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                    {% endif %}
                </div>

                <div class="card-body">
                    <!-- Subcategories -->
                    {% if category.subcategories %}
                        <h6 class="mt-3 mb-3">Subcategories</h6>
                        <div class="list-group">
                            {% for subcategory in category.subcategories %}
                                <div class="list-group-item bg-dark border-secondary d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <i class="fas {{ subcategory.icon }} me-2" style="color: {{ subcategory.color }};"></i>
                                        <span class="text-white">{{ subcategory.name }}</span>
                                    </div>
                                    {% if not subcategory.is_system %}
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="subcategoryActions{{ subcategory.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end bg-dark" aria-labelledby="subcategoryActions{{ subcategory.id }}">
                                            <li><a class="dropdown-item text-light" href="#" onclick="openEditCategory({{ subcategory.id }}, '{{ subcategory.name }}', '{{ subcategory.icon }}', '{{ subcategory.color }}'); return false;">
                                                <i class="fas fa-edit me-2"></i>Edit
                                            </a></li>
                                            <li><hr class="dropdown-divider border-secondary"></li>
                                            <li>
                                                <form action="{{ url_for('delete_category', category_id=subcategory.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this subcategory?');">
                                                    <button type="submit" class="dropdown-item text-danger">
                                                        <i class="fas fa-trash-alt me-2"></i>Delete
                                                    </button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No subcategories</p>
                    {% endif %}

                    <!-- Add Subcategory Button -->
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-light add-subcategory-btn" data-category-id="{{ category.id }}" data-category-name="{{ category.name }}">
                            <i class="fas fa-plus me-1"></i>Add Subcategory
                        </button>
                    </div>

                    <!-- Add Subcategory Form (Hidden by default) -->
                    <div id="subcategoryForm{{ category.id }}" class="subcategory-form mt-3 border-top pt-3" style="display: none;">
                        <h6 class="mb-3">Add Subcategory to {{ category.name }}</h6>
                        <form action="{{ url_for('add_category') }}" method="POST">
                            <input type="hidden" name="parent_id" value="{{ category.id }}">
                            <div class="mb-3">
                                <label for="subcategory_name{{ category.id }}" class="form-label">Subcategory Name</label>
                                <input type="text" class="form-control bg-dark text-light" id="subcategory_name{{ category.id }}" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="subcategory_icon{{ category.id }}" class="form-label">Icon</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-dark text-light" id="subcategory-icon-preview{{ category.id }}">
                                        <i class="fas fa-tag"></i>
                                    </span>
                                    <select class="form-select bg-dark text-light subcategory-icon-select" id="subcategory_icon{{ category.id }}" name="icon" data-preview-id="subcategory-icon-preview{{ category.id }}">
                                        {% for icon in icons %}
                                            <option value="{{ icon }}">{{ icon }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="subcategory_color{{ category.id }}" class="form-label">Color</label>
                                <div class="input-group">
                                    <input type="color" class="form-control form-control-color bg-dark subcategory-color" id="subcategory_color{{ category.id }}" name="color" value="#6c757d" data-hex-id="subcategory_colorHex{{ category.id }}">
                                    <input type="text" class="form-control bg-dark text-light" id="subcategory_colorHex{{ category.id }}" value="#6c757d" readonly>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-2 cancel-subcategory-btn" data-category-id="{{ category.id }}">Cancel</button>
                                <button type="submit" class="btn btn-primary">Add Subcategory</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <div class="alert alert-info">
                <h4 class="alert-heading"><i class="fas fa-info-circle me-2"></i>No categories found!</h4>
                <p>You don't have any expense categories set up yet. Categories help you organize and track your expenses more effectively.</p>
                <hr>
                <div class="d-flex justify-content-between align-items-center">
                    <p class="mb-0">You can add categories manually or create a set of default categories to get started.</p>
                    <form action="{{ url_for('user_create_default_categories') }}" method="POST">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-tags me-1"></i> Create Default Categories
                        </button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Use a custom edit form instead of a modal to avoid Bootstrap modal issues -->
<div id="editCategoryOverlay" class="position-fixed top-0 start-0 w-100 h-100" style="background-color: rgba(0,0,0,0.7); z-index: 2000; display: none;">
    <div class="position-absolute top-50 start-50 translate-middle" style="width: 90%; max-width: 500px;">
        <div class="card bg-dark text-light">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Edit Category</h5>
                <button type="button" class="btn-close btn-close-white" onclick="closeEditOverlay()"></button>
            </div>
            <form id="editCategoryForm" method="POST">
                <div class="card-body">
                    <div class="mb-3">
                        <label for="edit_name" class="form-label">Category Name</label>
                        <input type="text" class="form-control bg-dark text-light" id="edit_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_icon" class="form-label">Icon</label>
                        <div class="input-group">
                            <span class="input-group-text bg-dark text-light" id="edit-selected-icon-preview">
                                <i class="fas fa-tag"></i>
                            </span>
                            <select class="form-select bg-dark text-light" id="edit_icon" name="icon">
                                {% for icon in icons %}
                                    <option value="{{ icon }}">{{ icon }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_color" class="form-label">Color</label>
                        <div class="input-group">
                            <input type="color" class="form-control form-control-color bg-dark" id="edit_color" name="color" value="#6c757d">
                            <input type="text" class="form-control bg-dark text-light" id="edit_colorHex" value="#6c757d" readonly>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" onclick="closeEditOverlay()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle category form visibility
        document.getElementById('toggleCategoryForm').addEventListener('click', toggleCategoryForm);

        // Update color hex value when the color picker changes
        setupColorPicker('color', 'colorHex');
        setupColorPicker('edit_color', 'edit_colorHex');

        // Update icon preview when the icon dropdown changes
        setupIconPreview('icon', 'selected-icon-preview');
        setupIconPreview('edit_icon', 'edit-selected-icon-preview');

        // Setup subcategory forms
        setupSubcategoryButtons();

        // Setup subcategory color pickers
        document.querySelectorAll('.subcategory-color').forEach(picker => {
            const hexId = picker.dataset.hexId;
            setupColorPicker(picker.id, hexId);
        });

        // Setup subcategory icon previews
        document.querySelectorAll('.subcategory-icon-select').forEach(select => {
            const previewId = select.dataset.previewId;
            setupIconPreview(select.id, previewId);
        });
        
        // Setup keyboard trap for the overlay
        setupKeyboardTrap();
    });

    function toggleCategoryForm() {
        const form = document.getElementById('categoryFormContainer');
        const button = document.getElementById('toggleCategoryForm');

        if (form.style.display === 'none') {
            form.style.display = 'block';
            button.innerHTML = '<i class="fas fa-times me-2"></i>Cancel';
            button.classList.replace('btn-primary', 'btn-secondary');
        } else {
            form.style.display = 'none';
            button.innerHTML = '<i class="fas fa-plus me-2"></i>Add Category';
            button.classList.replace('btn-secondary', 'btn-primary');
        }
    }

    function setupSubcategoryButtons() {
        // Show subcategory form buttons
        document.querySelectorAll('.add-subcategory-btn').forEach(button => {
            button.addEventListener('click', function() {
                const categoryId = this.dataset.categoryId;
                document.getElementById(`subcategoryForm${categoryId}`).style.display = 'block';
                this.style.display = 'none';
            });
        });

        // Cancel subcategory form buttons
        document.querySelectorAll('.cancel-subcategory-btn').forEach(button => {
            button.addEventListener('click', function() {
                const categoryId = this.dataset.categoryId;
                document.getElementById(`subcategoryForm${categoryId}`).style.display = 'none';
                document.querySelector(`.add-subcategory-btn[data-category-id="${categoryId}"]`).style.display = 'inline-block';
            });
        });
    }

    function setupColorPicker(colorId, hexId) {
        const colorPicker = document.getElementById(colorId);
        const colorHex = document.getElementById(hexId);

        if (colorPicker && colorHex) {
            colorPicker.addEventListener('input', function() {
                colorHex.value = this.value;
            });
        }
    }

    function setupIconPreview(iconId, previewId) {
        const iconSelect = document.getElementById(iconId);
        const iconPreview = document.getElementById(previewId);

        if (iconSelect && iconPreview) {
            iconSelect.addEventListener('change', function() {
                const iconClass = this.value;
                iconPreview.innerHTML = `<i class="fas ${iconClass}"></i>`;
            });

            // Initialize preview with the default or selected value
            const initialIconClass = iconSelect.value;
            iconPreview.innerHTML = `<i class="fas ${initialIconClass}"></i>`;
        }
    }

    // Using custom overlay instead of Bootstrap modal
    function openEditCategory(categoryId, name, icon, color) {
        // Set the form action URL
        const form = document.getElementById('editCategoryForm');
        form.action = `/categories/edit/${categoryId}`;

        // Set the current values
        document.getElementById('edit_name').value = name;
        document.getElementById('edit_icon').value = icon;
        document.getElementById('edit_color').value = color;
        document.getElementById('edit_colorHex').value = color;

        // Update the icon preview
        const iconPreview = document.getElementById('edit-selected-icon-preview');
        iconPreview.innerHTML = `<i class="fas ${icon}" style="color: ${color};"></i>`;

        // Show the overlay
        document.getElementById('editCategoryOverlay').style.display = 'block';
        document.body.style.overflow = 'hidden'; // Prevent scrolling
        
        // Focus first field for accessibility
        setTimeout(() => {
            document.getElementById('edit_name').focus();
        }, 50);
    }

    function closeEditOverlay() {
        document.getElementById('editCategoryOverlay').style.display = 'none';
        document.body.style.overflow = ''; // Restore scrolling
    }
    
    function setupKeyboardTrap() {
        // Handle ESC key to close the overlay
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('editCategoryOverlay').style.display === 'block') {
                closeEditOverlay();
            }
        });
        
        // Add keyboard trap for tabbing in the overlay
        const overlay = document.getElementById('editCategoryOverlay');
        overlay.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                const focusableElements = overlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];
                
                if (e.shiftKey && document.activeElement === firstElement) {
                    e.preventDefault();
                    lastElement.focus();
                } else if (!e.shiftKey && document.activeElement === lastElement) {
                    e.preventDefault();
                    firstElement.focus();
                }
            }
        });
    }
</script>
{% endblock %}